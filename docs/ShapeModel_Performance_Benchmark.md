# ShapeModel 性能基准记录

## 测试环境

- **平台**: Linux (WSL2)
- **CPU**: (请填写具体型号)
- **编译器**: GCC with -O2/-O3
- **SIMD**: AVX2 + FMA
- **OpenMP**: 启用

## 测试图像

| 名称 | 尺寸 | 模板 ROI | 模型点数 |
|------|------|----------|----------|
| 小图 | 640×512 | 210×70 | 449 |
| 大图 | 2048×4001 | 135×200 | 476 |

---

## 2025-01-09 v4 AnglePyramid融合优化 (Fused Sobel+Mag+Dir+Quantize)

### 优化内容
1. **Pyramid.cpp**: v3融合优化 - 将高斯模糊和2x降采样合并为单次操作
2. **AnglePyramid.cpp**: v4融合优化 - 将 Sobel + Magnitude + Direction + Quantize 合并为单次遍历
   - `FusedSobelMagDirBin`: 一次遍历完成所有计算
   - AVX2 SIMD 加速 (8像素并行)
   - 减少中间缓冲区分配和内存带宽
3. **OpenMP 阈值**: `OPENMP_MIN_PIXELS=500000`

### 小图 (640×512) 性能

| 指标 | 耗时 | 备注 |
|------|------|------|
| **模型创建** | 5.1 ms | |
| **搜索总时间** | 29-45 ms | 取决于匹配难度 |
| - 金字塔构建 | ~20-34 ms | 搜索图像 AnglePyramid |
| - Coarse | 3-10 ms | 粗搜索 |
| - Refine | 0.2-0.8 ms | 精细化 |
| - SubPix | 0-0.9 ms | 亚像素定位 |
| - NMS | ~0 ms | 非极大值抑制 |

### 大图 (2048×4001) 性能

| 指标 | 耗时 | 备注 |
|------|------|------|
| **模型创建** | 6.8 ms | |
| **搜索总时间** | 267-588 ms | 平均 ~414 ms |
| - 金字塔构建 | ~230-530 ms | 占 ~87%，主要瓶颈 |
| - Coarse | 27-43 ms | 8700-12000 候选点 |
| - Refine | 5-15 ms | 精细化 |
| - SubPix | 0.2-1.1 ms | 亚像素定位 |
| - NMS | ~0 ms | 非极大值抑制 |

### 单元测试
- Gradient 相关: 36/36 通过
- Pyramid 相关: 43/43 通过
- ShapeModel 相关: 15/15 通过

---

## 历史记录

### 2025-01-09 v3 (Fused Gaussian + Downsample)

| 图像 | 模型创建 | 搜索时间 | 备注 |
|------|----------|----------|------|
| 小图 | 3.7 ms | 13-41 ms | |
| 大图 | 7.5 ms | 311-525 ms (avg 403) | 金字塔构建 270-460ms |

### 2025-01-09 v1 (Pyramid缓存优化 + 小图OpenMP阈值)

### 小图 (640×512) 性能

| 指标 | 耗时 | 备注 |
|------|------|------|
| **模型创建** | 3.7 ms | |
| **搜索总时间** | 13-41 ms | 取决于匹配难度 |
| - 金字塔构建 | ~25-33 ms | 搜索图像 AnglePyramid |
| - Coarse | 4-11 ms | 粗搜索 |
| - Refine | 0.2-0.7 ms | 精细化 |
| - SubPix | 0-0.4 ms | 亚像素定位 |
| - NMS | ~0 ms | 非极大值抑制 |

### 大图 (2048×4001) 性能

| 指标 | 耗时 | 备注 |
|------|------|------|
| **模型创建** | 7.5 ms | |
| **搜索总时间** | 311-525 ms | 平均 ~403 ms |
| - 金字塔构建 | ~270-460 ms | 占 ~90%，主要瓶颈 |
| - Coarse | 27-49 ms | 8700-12000 候选点 |
| - Refine | 7-13 ms | 精细化 |
| - SubPix | 0.2-1.6 ms | 亚像素定位 |
| - NMS | ~0 ms | 非极大值抑制 |

### 单元测试
- Gradient 相关: 36/36 通过
- Pyramid 相关: 43/43 通过
- ShapeModel 相关: 15/15 通过

---

## 历史记录

### 2025-01-09 v1 (Pyramid缓存优化 + 小图OpenMP阈值)

| 图像 | 模型创建 | 搜索时间 | 备注 |
|------|----------|----------|------|
| 小图 | 3.7-4.3 ms | 11-57 ms | |
| 大图 | 7.6-8.6 ms | 270-500 ms (avg ~380) | 金字塔构建 300-460ms |

### 2025-01-09 之前 (OpenMP+AVX2优化，无缓存优化)

| 图像 | 模型创建 | 备注 |
|------|----------|------|
| 小图 | ~70 ms | OpenMP 开销导致变慢 |
| 大图 | ~674 ms | |

### 2025-01-09 最初 (无优化)

| 图像 | 模型创建 | 备注 |
|------|----------|------|
| 大图 | ~900 ms | AnglePyramid 构建是瓶颈 |

---

## 待优化项

1. **搜索图像金字塔缓存**: 同一图像多次搜索时避免重复构建
2. **ROI 搜索**: 限制搜索区域减少计算量
3. **搜索图像 AnglePyramid 优化**: 目前占搜索时间 91%

---

## 如何运行基准测试

```bash
# 小图测试
rm -f shape_model.qism && ./build/bin/samples/07_shape_match_draw

# 大图测试
rm -f shape_model_large.qism && ./build/bin/samples/08_shape_match_large
```
